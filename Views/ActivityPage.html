<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activities</title>
    <link rel="stylesheet" href="Styles/ActivityPageStyle.css">
</head>
<body>
    <header>
        <h1>Activities</h1>
    </header>
    <main>
        <button id="addEntryButton" style="margin-bottom: 20px;">New Activity</button>
        <table>
            <thead>
                <tr>
                    <th>Activity</th>
                    <th>Duration (min)</th>
                    <th>Calories Burned</th>
                    <th>Delete</th>
                    <th>Edit</th>
                </tr>
            </thead>
            <tbody id="activityTableBody">
                <!-- Table rows will be dynamically added here -->
                <tr></tr>
            </tbody>
        </table>
    </main>

    <script>
        // Fetch the database from SQL server.
        document.addEventListener('DOMContentLoaded', function(id) { 
            var user;
            var activities;
            
            // Nested fetches (ugh!).
            fetch('http://localhost:8080/users/1', {
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(function (userRes) {
                if (!userRes.ok) {
                    throw new Error('Failed to fetch user');
                }
                return userRes.json();
            })
            .then(function (userData) {
                user = userData;
                return fetch(`http://localhost:8080/tracksactivities/${userData.UserID}`);
            })
            .then(function (activitiesRes) {
                if (!activitiesRes.ok) {
                    throw new Error('Failed to fetch activities');
                }
                return activitiesRes.json();
            })
            .then(function (activitiesData) { // This requires some sort of iteration (map) to go through all the data.
                const activityIDs = activitiesData.map(activity => activity.ActivityID);
                const activityFetchPromises = activityIDs.map(activityID => fetch(`http://localhost:8080/activities/${activityID}`,
                    {
                        headers : {
                            "Content-Type" : "application/json"
                        }
                    }
                ));
                
                return Promise.all(activityFetchPromises);
            })
            .then(function (activityResponses) {
                const activityJSONPromises = activityResponses.map(response => response.json());
                
                return Promise.all(activityJSONPromises);
            })
            .then(function (activityJSONs) {
                console.log(activityJSONs);
                loadTable(activityJSONs);
            })
            .catch(function (error) {
                console.error('Error:', error);
            });
        });

        const addButton = document.querySelector('#addEntryButton');

        // JavaScript to handle adding entries to the table
        addButton.onclick = function (data) {
            var name = prompt('Enter activity:');
            var duration = prompt('Enter duration in minutes:');
            var calories = prompt('Enter calories burned:');
            
            if (name && duration && calories) {
                var tableBody = document.getElementById('activityTableBody');
                var newRow = document.createElement('tr');
                newRow.innerHTML = `<td id="name-col">`+ name +`</td>`+ `<td id="dur-col">` + duration +`</td>` + 
                `<td id="cal-col">` + calories + `</td>` + 
                `<td><button class="delete-btn" onclick="deleteRowById(this.parentNode.parentNode.dataset.id)">Delete</td>` +
                `<td><button class="edit-btn">Edit</td>`;
                fetch('http://localhost:8080/createactivities', { 
                    method : 'POST',
                    headers : {
                        "Content-Type" : "application/json"
                    },
                    cache : "no-cache",
                    body : JSON.stringify(
                        {
                            ActivityName : name,
                            DurationTime : duration,
                            TotalCaloriesBurnt : calories
                        }
                    )
                })
                .then(response => response.json())
                .then(data => console.log(data))
                .catch(err => console.log(err));
                tableBody.appendChild(newRow);
            } else {
                alert('Please enter valid values for all fields.');
            }
        };

        document.querySelector('table tbody').addEventListener('click', function(event) {
            if (event.target.className === "delete-btn") {
                deleteRowById(event.target.dataset.id);
            }
            if (event.target.className === "edit-btn") {
                editRowById(event.target.dataset.id);
            }
        })

        // Row can be deleted once "Delete" button is pressed.
        function deleteRowById(id) {
            fetch(`http://localhost:8080/deleteactivities/${id}`, {
                method: 'DELETE'
            })
            .then(function (res) {
                if (!res.ok) throw new Error("Failed to delete row.");
                location.reload();
            })
            .catch(error => console.error("Failed to delete row."));
        }

        // Row can have its values edited once "Edit" button is pressed.
        function editRowById(id) {
            var name = prompt('Enter activity:');
            var duration = prompt('Enter duration in minutes:');
            var calories = prompt('Enter calories burned:');

            if (name && duration && calories) {
                fetch(`http://localhost:8080/updateactivities/`, {
                    method : 'PUT',
                    headers : {
                        "Content-Type" : "application/json"
                    },
                    body : JSON.stringify( 
                    {
                        ActivityName : name,
                        DurationTime : duration,
                        TotalCaloriesBurnt : calories,
                        ActivityID : id
                    }),
                    cache : 'no-cache'
                })
                .then(res => {
                    if (!res.ok) throw new Error("Failed to update row.");
                    return res.json();
                })
                .then(data => {
                    console.log("Row updated.", data);
                    const row = document.querySelector(`tr[data-id="${id}"]`);
                    if (row) {
                        row.querySelector("#name-col").textContent = name;
                        row.querySelector("#dur-col").textContent = duration;
                        row.querySelector("cal-col").textContent = calories;

                        row.querySelector("#name-col").setAttribute("data-name", name);
                        row.querySelector("#dur-col").setAttribute("data-duration", duration);
                        row.querySelector("#cal-col").setAttribute("data-calories", calories);
                    }
                })
                .then(data => {
                    location.reload();
                })
                .catch(error => console.error("Failed to update row."));
            } else {
                alert("Please enter valid values for all fields.");
            }
        }

        // Load the database table into HTML file.
        function loadTable(data) {
            console.log("Loading table from database...");
            console.log(data);

            let table = document.querySelector('table tbody');

            let tableHTML = "";

            data.forEach(function ( {ActivityID, ActivityName, DurationTime, TotalCaloriesBurnt} ) {
                tableHTML += "<tr>";
                tableHTML += `<td>"${ActivityName}"</td>`;
                tableHTML += `<td>"${DurationTime}"</td>`;
                tableHTML += `<td>"${TotalCaloriesBurnt}"</td>`;
                tableHTML += `<td><button class="delete-btn" onclick="deleteRowById(this.parentNode.parentNode.dataset.id)" data-id=${ActivityID}/>Delete</td>`
                tableHTML += `<td><button class="edit-btn" data-id=${ActivityID}>Edit</td>`
                tableHTML += "</tr>";
            });

            table.innerHTML = tableHTML;
        }
    </script>
</body>
</html>
