<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activities</title>
    <link rel="stylesheet" href="Styles/ActivityPageStyle.css">
</head>
<body>
    <header>
        <h1>Activities</h1>
    </header>
    <main>
        <button id="addEntryButton" style="margin-bottom: 20px;">New Activity</button>
        <table>
            <thead>
                <tr>
                    <th>Activity</th>
                    <th>Duration (min)</th>
                    <th>Calories Burned</th>
                    <th>Delete</th>
                    <th>Edit</th>
                </tr>
            </thead>
            <tbody id="activityTableBody">
                <!-- Table rows will be dynamically added here -->
                <tr></tr>
            </tbody>
        </table>
    </main>

    <script>
        // Fetch the database from SQL server.
        document.addEventListener('DOMContentLoaded', function(id) { 
            // Variables below are needed to save fetched data.
            var user;
            var activities;
            
            // Chained fetches (ugh!).
            // First, fetch a request to get one user based on their user ID (globalized).
            fetch('http://localhost:8080/users/1', {
                headers: {
                    "Content-Type": "application/json"
                }
            })
            // User's data is returned in JSON format.
            .then(function (userRes) {
                if (!userRes.ok) {
                    throw new Error('Failed to fetch user');
                }
                return userRes.json();
            })
            .then(function (userData) {
                 // The user data gets transfered to the variable.
                user = userData;
                // Next, fetch a request to get the TracksActivities table with the fetched user ID from before.
                return fetch(`http://localhost:8080/tracksactivities/${userData.UserID}`);
            })
            // A table of the fetched user's activities data is returned in JSON format.
            .then(function (activitiesRes) {
                if (!activitiesRes.ok) {
                    throw new Error('Failed to fetch activities');
                }
                return activitiesRes.json();
            })
            // Since activities data is in an array, each activity must be isolated from the array using the map() function to iterate through the activities.
            // Then, each activity ID sends a fetch request to receive each 
            .then(function (activitiesData) { // This requires iteration with map() to go through all the data.
                const activityIDs = activitiesData.map(activity => activity.ActivityID);
                const activityFetchPromises = activityIDs.map(activityID => fetch(`http://localhost:8080/activities/${activityID}`,
                    {
                        headers : {
                            "Content-Type" : "application/json"
                        }
                    }
                ));
                
                // Promise.all() ensures that all the iterated fetched activities are returned as a single Promise.
                // Having multiple Promises returned may cause errors to the fetch chain (though I'm not exactly sure what errors would arise).
                return Promise.all(activityFetchPromises);
            })
            // Another iteration/map is required to convert all the activities in the table to JSON format.
            .then(function (activityResponses) {
                const activityJSONPromises = activityResponses.map(response => response.json());
                
                // The activities in JSON format all get returned as a single Promise.
                return Promise.all(activityJSONPromises);
            })
            .then(function (activityJSONs) {
                console.log(activityJSONs);
                // Function loadTable() is called to start loading the table from the database.
                loadTable(activityJSONs);
            })
            // Any errors in the fetch chain are caught below.
            .catch(function (error) {
                console.error('Error:', error);
            });
        });

        const addButton = document.querySelector('#addEntryButton');

        // JavaScript to handle adding entries to the table
        addButton.onclick = function (data) {
            var name = prompt('Enter activity:');
            var duration = prompt('Enter duration in minutes:');
            var calories = prompt('Enter calories burned:');
            
            if (name && duration && calories) {
                // Unused
                var tableBody = document.getElementById('activityTableBody');
                var newRow = document.createElement('tr');
                newRow.innerHTML = `<td id="name-col">`+ name + `</td>`+ 
                                   `<td id="dur-col">` + duration +`</td>` + 
                                   `<td id="cal-col">` + calories + `</td>` + 
                                   `<td><button class="delete-btn">Delete</td>` +
                                   `<td><button class="edit-btn">Edit</td>`;
                // Unused

                fetch('http://localhost:8080/createactivities', { 
                    method : 'POST',
                    headers : {
                        "Content-Type" : "application/json"
                    },
                    cache : "no-cache",
                    body : JSON.stringify(
                        {
                            ActivityName : name,
                            DurationTime : duration,
                            TotalCaloriesBurnt : calories
                        }
                    )
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    // Unused
                    newRow.setAttribute('data-id', data.ActivityID)
                    // Unused

                })
                .catch(err => console.log(err));
                location.reload();
            } else {
                alert('Please enter valid values for all fields.');
            }
        };

        document.querySelector('table tbody').addEventListener('click', function(event) {
            if (event.target.className === "delete-btn") {
                var rowID = event.target.dataset.id;
                deleteRowById(rowID);
            }
            if (event.target.className === "edit-btn") {
                var rowID = event.target.dataset.id;
                editRowById(rowID);
            }
        })

        // Row can be deleted once "Delete" button is pressed.
        function deleteRowById(id) {
            // Send a fetch request with the activity ID argument.
            fetch(`http://localhost:8080/deleteactivities/${id}`, {
                method: 'DELETE'
            })
            .then(function (res) {
                if (!res.ok) throw new Error("Failed to delete row.");
                // Current webpage reloads once the row is deleted from the database table.
                location.reload();
            })
            .catch(error => console.error("Failed to delete row."));
        }

        // Row can have its values edited once "Edit" button is pressed.
        function editRowById(id) {
            // Prompts are similar to the function to add rows.
            var name = prompt('Enter activity:');
            var duration = prompt('Enter duration in minutes:');
            var calories = prompt('Enter calories burned:');

            if (name && duration && calories) {
                fetch(`http://localhost:8080/updateactivities/`, {
                    method : 'PUT',
                    headers : {
                        "Content-Type" : "application/json"
                    },
                    body : JSON.stringify( 
                    {
                        ActivityName : name,
                        DurationTime : duration,
                        TotalCaloriesBurnt : calories,
                        ActivityID : id
                    }),
                    cache : 'no-cache'
                })
                .then(res => {
                    if (!res.ok) throw new Error("Failed to update row.");
                    return res.json();
                })
                // Unused
                .then(data => {
                    const row = document.querySelector(`tr[data-id="${id}"]`);
                    if (row) {
                        row.querySelector("#name-col").textContent = name;
                        row.querySelector("#dur-col").textContent = duration;
                        row.querySelector("cal-col").textContent = calories;

                        row.querySelector("#name-col").setAttribute("data-name", name);
                        row.querySelector("#dur-col").setAttribute("data-duration", duration);
                        row.querySelector("#cal-col").setAttribute("data-calories", calories);
                    }
                // Unused

                })
                .then(data => {
                    location.reload();
                })
                .catch(error => console.error("Failed to update row."));
            } else {
                alert("Please enter valid values for all fields.");
            }
        }

        // Load the database table into HTML file.
        function loadTable(data) {
            console.log("Loading table from database...");
            console.log(data);

            // Variable table will hold the table loaded from the database.
            let table = document.querySelector('table tbody');

            // Variable tableHTML will load the HTML contents to table.innerHTML.
            let tableHTML = "";

            // Each row of the database table is outputted through the iteration below [forEach()].
            data.forEach(function ( {ActivityID, ActivityName, DurationTime, TotalCaloriesBurnt} ) {
                tableHTML += "<tr>";
                tableHTML += `<td id="name-col">"${ActivityName}"</td>`;
                tableHTML += `<td id="dur-col">"${DurationTime}"</td>`;
                tableHTML += `<td id="cal-col">"${TotalCaloriesBurnt}"</td>`;
                tableHTML += `<td><button class="delete-btn" data-id=${ActivityID}/>Delete</td>`
                tableHTML += `<td><button class="edit-btn" data-id=${ActivityID}>Edit</td>`
                tableHTML += "</tr>";
            });

            table.innerHTML = tableHTML;
        }
    </script>
</body>
</html>
